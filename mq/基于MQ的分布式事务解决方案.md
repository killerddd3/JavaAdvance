# 基于MQ的分布式事务解决方案

### 什么是分布式系统

1. 一个用户的请求需要多个系统协同完成的系统称为分布式系统。

### 了解分布式事务

1. 数据的一致性，不是指数据一模一样，而是用户的操作落盘数据库。
2. CAP定理，又称为布鲁尔定理，1998年第一次提出，最初是指分布式数据存储不可能同时提供以下三种保证中的两种以上：
   * 一致性：每次读取到的信息都是最新的。
   * 可用性：每个请求都会受到(非错误)响应。
   * 分区容错：尽管节点之间的网络不通导致分区，系统继续运行，功能正常。
3. 分布式事务处理的理论基础，BASE是Basically Available，SoftState，Eventually Consistency三个短语的缩写。
   * 基本可用：可能是部分功能不可用或者是响应时间长。
   * 软状态：不同系统/节点之间，数据存在过渡状态。
   * 最终一致：经过系统内部协调机制，最终所有节点保持一致。

### 了解RabbitMQ

一款分布式消息中间件，基于erlang语言开发，具备语言级别的高并发处理能力，和Spring框架是同一家公司，支持持久化，高可用。了解其中5个核心概念。

1. Queue：真正存储数据的地方。

2. Exchange：接收请求，转存数据。

3. Bind：收到请求后存储到哪里。

4. 消息生产者：发送数据的应用。

5. 消息消费者：取出数据处理的应用。

   ![1561259212638](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561259212638.png)

### 分布式事务的几种解决方案

1. 基于数据库XA/JTA协议的方式，需要数据库产商支持，JAVA组件有atomikos等。

2. 异步校对数据的方式，支付宝，微信支付主动查询支付状态，对账单的形式。

3. 基于可靠消息(MQ)的解决方案，异步场景，通用性较强，拓展性较高。

4. TCC编程式解决方案，严选，阿里，蚂蚁金服自己封装的DTX。

### 美团点评系统架构

![1561259579090](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561259579090.png)

### 多系统间的分布式事务问题

![1561259670243](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561259670243.png)

错误示例：

![1561259742666](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561259742666.png)

在上面的例子中，会误以为当接口调用失败时，订单系统事务回滚，提示用户操作失败，就不会有分布式事务问题，其实不然。接口调用成功或者失败，都会产生分布式事务问题。

1. 接口调用成功，订单系统数据库事务提交失败，运单系统没有回滚，产生数据。
2. 接口调用超时，订单系统数据库事务回滚，运单系统接口继续执行，产生数据。

### 整体设计思路

![1561260004889](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260004889.png)

### 步骤1-可靠消费生产-记录消息发送

![1561260118143](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260118143.png)

### 步骤2-可靠消费生产-修改消息发送状态

利用RabbitMQ发布确认机制。开启确认发布机制后，MQ准确受理消息并返回回执。

![1561260359689](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260359689.png)

### 步骤3-可靠消息消费-正常处理

开启手动ACK模式。有消费者控制消息的重发/清除/丢弃。幂等性。防止重复处理，一次用户操作，只对应一次数据处理。

![1561260536128](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260536128.png)



### 步骤4-可靠消息处理-消息重发

消费者处理失败，需要MQ再次重发给消费者。出现异常一般会重试几次，有消费者自身记录重试次数，并进行次数控制。

![1561260684659](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260684659.png)

### 步骤4-可靠消息处理-消息丢弃

消费者处理失败，直接丢弃或者转移到死信队列(DLQ)。重试次数过多，消息内容格式错误等无法恢复的情况，通过线上预警机制通知运维人员。

![1561260767871](C:\Users\zhu\AppData\Roaming\Typora\typora-user-images\1561260767871.png)

### 优点和缺点

1. 优点
   * 通用性强。
   * 拓展性强。
   * 方案成熟。
2. 缺点
   * 基于消息中间件，只适合异步场景。
   * 消息处理会延迟，需要业务上能够容忍。
3. 尽量避免分布式事务。尽量将非核心事务做成异步。





   

